"use strict";var y=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var d=(r,e)=>y(r,"name",{value:e,configurable:!0});var S=(r,e)=>{for(var t in e)y(r,t,{get:e[t],enumerable:!0})},b=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of k(e))!q.call(r,n)&&n!==t&&y(r,n,{get:()=>e[n],enumerable:!(s=E(e,n))||s.enumerable});return r};var T=r=>b(y({},"__esModule",{value:!0}),r);var O={};S(O,{handler:()=>D});module.exports=T(O);var f=require("@aws-sdk/client-macie2");var h=class{static{d(this,"MacieFindingsRetriever")}client;logger;constructor(e,t){this.logger=e,this.client=new f.Macie2Client({region:t||process.env.AWS_REGION||"us-east-1"})}transformFinding(e){return{id:e.id||"",accountId:e.accountId||"",archived:e.archived||!1,category:e.category||"",classificationDetails:e.classificationDetails?{jobArn:e.classificationDetails.jobArn||"",jobId:e.classificationDetails.jobId||"",result:e.classificationDetails.result?{status:e.classificationDetails.result.status?{code:e.classificationDetails.result.status.code||"",reason:e.classificationDetails.result.status.reason}:void 0,sensitiveData:e.classificationDetails.result.sensitiveData?.map(t=>({category:t.category||"",detections:t.detections?.map(s=>({type:s.type||"",count:s.count||0}))||[],totalCount:t.totalCount||0}))||[]}:void 0}:void 0,count:e.count||0,createdAt:e.createdAt||"",description:e.description||"",partition:e.partition||"",region:e.region||"",resourcesAffected:e.resourcesAffected?{s3Bucket:e.resourcesAffected.s3Bucket?{arn:e.resourcesAffected.s3Bucket.arn||"",name:e.resourcesAffected.s3Bucket.name||"",owner:e.resourcesAffected.s3Bucket.owner?{displayName:e.resourcesAffected.s3Bucket.owner.displayName||"",id:e.resourcesAffected.s3Bucket.owner.id||""}:void 0,tags:e.resourcesAffected.s3Bucket.tags?.map(t=>({key:t.key||"",value:t.value||""}))||[]}:void 0,s3Object:e.resourcesAffected.s3Object?{bucketArn:e.resourcesAffected.s3Object.bucketArn||"",eTag:e.resourcesAffected.s3Object.eTag||"",key:e.resourcesAffected.s3Object.key||"",lastModified:e.resourcesAffected.s3Object.lastModified||"",size:e.resourcesAffected.s3Object.size||0,storageClass:e.resourcesAffected.s3Object.storageClass||"",tags:e.resourcesAffected.s3Object.tags?.map(t=>({key:t.key||"",value:t.value||""}))||[]}:void 0}:void 0,sample:e.sample||!1,schemaVersion:e.schemaVersion||"",severity:e.severity?{description:e.severity.description||"",score:e.severity.score||0}:void 0,title:e.title||"",type:e.type||"",updatedAt:e.updatedAt||""}}async getFindingsForJobPaginated(e,t=50,s){this.logger.info("Starting paginated findings retrieval",{jobId:e,maxResults:t,hasNextToken:!!s});try{let n=Date.now(),i=new f.ListFindingsCommand({findingCriteria:{criterion:{"classificationDetails.jobId":{eq:[e]}}},maxResults:Math.min(t,50),nextToken:s}),o=await this.client.send(i),u=Date.now()-n;if(this.logger.logApiResponse("Macie2","ListFindings",o,u),!o.findingIds||o.findingIds.length===0)return this.logger.info("No findings found for job",{jobId:e}),{findings:[],nextToken:void 0,totalCount:0};let l=Date.now(),R=new f.GetFindingsCommand({findingIds:o.findingIds}),g=await this.client.send(R),a=Date.now()-l;this.logger.logApiResponse("Macie2","GetFindings",g,a);let m=g.findings?g.findings.map(x=>this.transformFinding(x)):[];return this.logger.info("Completed paginated findings retrieval",{jobId:e,findingsReturned:m.length,hasNextToken:!!o.nextToken}),{findings:m,nextToken:o.nextToken,totalCount:m.length}}catch(n){throw this.logger.error("Failed to retrieve paginated findings",n,{jobId:e,maxResults:t}),n}}};var A=class{static{d(this,"Logger")}context;constructor(e){this.context=e}info(e,t){let s={level:"INFO",timestamp:new Date().toISOString(),requestId:this.context.requestId,functionName:this.context.functionName,functionVersion:this.context.functionVersion,message:e,data:t?this.sanitizeData(t):void 0};console.log(JSON.stringify(s))}error(e,t,s){let n={level:"ERROR",timestamp:new Date().toISOString(),requestId:this.context.requestId,functionName:this.context.functionName,functionVersion:this.context.functionVersion,message:e,error:t?{name:t.name,message:t.message,stack:t.stack,...t}:void 0,data:s?this.sanitizeData(s):void 0};console.error(JSON.stringify(n))}debug(e,t){let s={level:"DEBUG",timestamp:new Date().toISOString(),requestId:this.context.requestId,functionName:this.context.functionName,functionVersion:this.context.functionVersion,message:e,data:t?this.sanitizeData(t):void 0};console.log(JSON.stringify(s))}logApiRequest(e,t,s){this.info(`${e} API Request: ${t}`,{service:e,operation:t,parameters:this.sanitizeData(s)})}logApiResponse(e,t,s,n){this.info(`${e} API Response: ${t}`,{service:e,operation:t,duration:n?`${n}ms`:void 0,response:this.sanitizeData(s)})}logTiming(e,t){let s=Date.now()-t;this.info(`Operation completed: ${e}`,{operation:e,duration:`${s}ms`})}sanitizeData(e){if(!e)return e;let t=JSON.parse(JSON.stringify(e)),s=["password","secret","token","key","authorization","auth","credential","clientToken"];return this.maskSensitiveFields(t,s)}maskSensitiveFields(e,t){if(typeof e!="object"||e===null)return e;if(Array.isArray(e))return e.map(n=>this.maskSensitiveFields(n,t));let s={};for(let[n,i]of Object.entries(e)){let o=n.toLowerCase();t.some(l=>o.includes(l.toLowerCase()))&&typeof i=="string"?s[n]="***MASKED***":typeof i=="object"?s[n]=this.maskSensitiveFields(i,t):s[n]=i}return s}};var I=class{static{d(this,"ErrorHandler")}logger;context;constructor(e,t){this.logger=e,this.context=t}handleValidationError(e,t){return this.logger.error("Validation Error",void 0,{receivedData:t}),{success:!1,error:{type:"ValidationError",message:e,details:"The provided input does not conform to the expected schema",requestId:this.context.awsRequestId}}}handleAwsApiError(e,t,s){return this.logger.error(`${t} API Error`,e,{service:t,operation:s,errorCode:e.name,statusCode:e.$metadata?.httpStatusCode,awsRequestId:e.$metadata?.requestId}),{success:!1,error:{type:e.name||`${t}ApiError`,message:e.message||`Failed to execute ${t} ${s}`,details:{errorCode:e.name,statusCode:e.$metadata?.httpStatusCode,awsRequestId:e.$metadata?.requestId},requestId:this.context.awsRequestId}}}handleUnexpectedError(e){return this.logger.error("Unexpected Error",e),{success:!1,error:{type:"UnexpectedError",message:e.message||"An unexpected error occurred",details:{name:e.name,stack:e.stack},requestId:this.context.awsRequestId}}}handleCustomError(e,t,s){return this.logger.error(`Custom Error: ${e}`,void 0,{details:s}),{success:!1,error:{type:e,message:t,details:s,requestId:this.context.awsRequestId}}}handleEventBridgeValidationError(e,t,s){return this.logger.error("EventBridge Validation Error",void 0,{eventBusArn:t,validationError:s}),{success:!1,error:{type:"EventBridgeValidationError",message:e,details:{eventBusArn:t,validationError:s,requiredTagKey:"JobStatusEventBusArn",expectedArnFormat:"arn:aws:events:region:account:event-bus/name"},requestId:this.context.awsRequestId}}}handleError(e,t){return e.$metadata?this.handleAwsApiError(e,t?.service||"AWS",t?.operation||"Unknown"):e.type&&e.message?this.handleCustomError(e.type,e.message,e.details):this.handleUnexpectedError(e)}};var D=d(async(r,e)=>{let t=Date.now(),s=new A({requestId:e.awsRequestId,functionName:e.functionName,functionVersion:e.functionVersion}),n=new I(s,e);s.info("Lambda function started",{functionName:e.functionName,functionVersion:e.functionVersion,remainingTimeInMillis:e.getRemainingTimeInMillis(),eventType:"API Gateway"});try{return await P(r,e,s,n,t)}catch(i){return s.error("Unexpected error in Lambda execution",i),v(500,"Internal Server Error",i.message,e.awsRequestId)}},"handler");async function P(r,e,t,s,n){t.info("Processing API Gateway request",{httpMethod:r.httpMethod,resource:r.resource,path:r.path});let i=N(r);if(!i.success){let c=i.error;return t.error("Invalid request parameters",{error:c}),v(400,"Bad Request",c,e.awsRequestId)}let{jobId:o,maxResults:u=50,nextToken:l}=i.data;t.info("Processing findings request",{jobId:o,maxResults:u,hasNextToken:!!l}),t.info("Initializing Macie findings retriever");let R=new h(t);t.info("Retrieving paginated findings",{jobId:o,maxResults:u});let g=Date.now(),a;try{a=await R.getFindingsForJobPaginated(o,u,l)}catch(c){return t.error("Failed to retrieve findings from Macie",c,{jobId:o}),v(500,"Macie API Error",c.message,e.awsRequestId)}let m=Date.now()-g;t.info("Successfully retrieved paginated findings",{jobId:o,findingsReturned:a.findings.length,totalFindings:a.totalCount,hasNextToken:!!a.nextToken,retrievalDuration:`${m}ms`});let x={success:!0,data:{jobId:o,findings:a.findings,totalFindings:a.totalCount,maxResults:u,nextToken:a.nextToken,requestId:e.awsRequestId}};return t.info("Findings retrieval completed",{jobId:o,findingsReturned:a.findings.length,totalFindings:a.totalCount,findingsByCategory:a.findings.reduce((c,p)=>(c[p.category]=(c[p.category]||0)+1,c),{}),findingsBySeverity:a.findings.reduce((c,p)=>{let C=p.severity?.description||"Unknown";return c[C]=(c[C]||0)+1,c},{})}),t.logTiming("GetMacieFindings API execution",n),{statusCode:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type, X-Amz-Date, Authorization, X-Api-Key, X-Amz-Security-Token"},body:JSON.stringify(x)}}d(P,"handleAPIGatewayEvent");function N(r){let e=r.queryStringParameters;if(!e||!e.jobId)return{success:!1,error:"Missing required parameter: jobId"};let t=e.jobId.trim();if(!t)return{success:!1,error:"jobId parameter cannot be empty"};let s=50;if(e.maxResults){let i=parseInt(e.maxResults,10);if(isNaN(i)||i<1||i>50)return{success:!1,error:"maxResults must be a number between 1 and 50"};s=i}let n=e.nextToken||void 0;return{success:!0,data:{jobId:t,maxResults:s,nextToken:n}}}d(N,"parseAPIGatewayRequest");function v(r,e,t,s){return{statusCode:r,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type, X-Amz-Date, Authorization, X-Api-Key, X-Amz-Security-Token"},body:JSON.stringify({success:!1,error:{type:e,message:t,requestId:s}})}}d(v,"createAPIGatewayErrorResponse");0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
